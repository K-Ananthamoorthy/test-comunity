<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Page</title>

    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Custom CSS for community page */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #007bff;
        }
        .user-details {
            text-align: center;
            margin-bottom: 20px;
        }
        .user-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 3px solid #007bff;
            display: block;
            margin: 0 auto;
        }
        .user-name {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 5px;
            color: #333;
        }
        .user-email {
            color: #666;
            font-size: 16px;
        }
        .logout-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            border: none;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .logout-button:hover {
            background-color: #c82333;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group input[type="text"] {
            width: calc(100% - 100px);
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .form-group button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            background-color: #007bff;
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
        }
        .form-group button:hover {
            background-color: #0056b3;
        }
        .post {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .post-content {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .interaction-buttons {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
        }
        .interaction-buttons button {
            border-radius: 5px;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .interaction-buttons button:hover {
            opacity: 0.8;
        }
        .like-button {
            background-color: #007bff;
            color: #fff;
        }
        .liked-button {
            background-color: #28a745;
            color: #fff;
        }
        .glow {
            animation: glow 1s ease infinite alternate;
        }
        @keyframes glow {
            from {
                box-shadow: 0 0 10px #007bff;
            }
            to {
                box-shadow: 0 0 20px #007bff;
            }
        }
        .comment {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f0f2f5;
        }
        .comment-content {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .comment-buttons button {
            margin-right: 5px;
            padding: 3px 8px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .comment-buttons button:hover {
            background-color: #007bff;
            color: #fff;
        }

        /* Media queries for responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .logout-button {
                top: 10px;
                right: 10px;
            }
            .user-image {
                width: 80px;
                height: 80px;
            }
            .user-name {
                font-size: 18px;
            }
            .user-email {
                font-size: 14px;
            }
            .form-group input[type="text"] {
                width: calc(100% - 90px);
            }
            .form-group button {
                padding: 8px 15px;
                font-size: 14px;
            }
            .interaction-buttons button {
                padding: 6px 12px;
                font-size: 14px;
            }
            .comment-buttons button {
                padding: 2px 4px;
                font-size: 12px;
            }
            .post-content,
            .comment-content {
                font-size: 16px;
                font-weight: bold;
            }
        }

        .container {
    max-width: 800px;
    margin: 20px auto;
    padding: 20px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.header h1 {
    color: #007bff;
    margin: 0;
}

.new-post-form {
    display: flex;
    margin-bottom: 20px;
}

.new-post-form input[type="text"] {
    flex: 1;
    margin-right: 10px;
}



    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>oXo</h1>
            <button class="btn btn-primary logout-button" onclick="logout()">Logout</button>
        </div>
    
        <!-- User Details -->
        <div class="user-details">
           <b><h2>Profile </h2></b> 
            <img src="" alt="User Image" class="user-image" id="userImage">
            <div class="user-info">
                <div class="user-name" id="userName"></div>
                <div class="user-email" id="userEmail"></div>
            </div>
        </div>
    
        <!-- New Post Form -->
        <div class="new-post-form">
            <input type="text" class="form-control" id="postInput" placeholder="Write something...">
            <button class="btn btn-primary" onclick="post()">Post</button>
        </div>
    
        <!-- Posts Section -->
        <div id="posts-section">
            <!-- Posts will be dynamically added here -->
        </div>
    </div>
    


        
        <!-- Posts Section -->
        <div id="posts-section">
            <!-- Posts will be dynamically added here -->
        </div>
    </div>


<!-- Firebase JavaScript SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.2/firebase-database-compat.js"></script>

<script>
  		        const firebaseConfig = {
    apiKey: "AIzaSyCN0VLc3wYAeKBk06g-HVtE4dDPcEZo6xk",
    authDomain: "aiml-smvitm.firebaseapp.com",
    projectId: "aiml-smvitm",
    storageBucket: "aiml-smvitm.appspot.com",
    messagingSenderId: "867145474581",
    databaseURL: "https://aiml-smvitm-default-rtdb.asia-southeast1.firebasedatabase.app",
    appId: "1:867145474581:web:a2e294081b458bdb69e41c",
    measurementId: "G-64CF103MLC"
  };
    firebase.initializeApp(firebaseConfig);

    // Logout function
    function logout() {
        firebase.auth().signOut().then(() => {
            // Sign-out successful.
            window.location.href = "/login.html";
        }).catch((error) => {
            console.error('Sign out error:', error);
        });
    }

    // Function to fetch user details and populate them
    function fetchUserDetails() {
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in.
                console.log("Current user:", user);
                
                // Set user image
                const userImage = document.querySelector('.user-image');
                userImage.src = user.photoURL;

                // Set username
                const userName = document.querySelector('.user-name');
                userName.innerText = user.displayName;

                // Set user email
                const userEmail = document.querySelector('.user-email');
                userEmail.innerText = user.email;
            } else {
                // No user is signed in.
                console.log('User not logged in');
            }
        });
    }

    // Function to post
    function post() {
        const user = firebase.auth().currentUser;
        const postInput = document.getElementById('postInput');
        const postData = postInput.value.trim();
        if (postData !== '' && user) {
            firebase.database().ref('posts').push({
                userId: user.uid,
                userName: user.displayName,
                userImage: user.photoURL,
                text: postData,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                likes: {}, // Initialize likes as object to store user likes
                shares: 0, // Initial shares count
                comments: {} // Initial empty comments
            }).then(() => {
                postInput.value = '';
            }).catch((error) => {
                console.error('Error posting:', error);
            });
        }
    }

  // Function to fetch posts
function fetchPosts() {
    firebase.database().ref('posts').orderByChild('timestamp').on('value', (snapshot) => {
        const postsSection = document.getElementById('posts-section');
        postsSection.innerHTML = ''; // Clear previous posts
        snapshot.forEach((childSnapshot) => {
            const post = childSnapshot.val();
            const postId = childSnapshot.key;
            const user = firebase.auth().currentUser;
            const isCurrentUserPost = user && post.userId === user.uid;

            const postElement = document.createElement('div');
            postElement.classList.add('post');

            // Construct post content
            const postContent = `
                <div class="user-info">
                    <img src="${post.userImage}" class="user-image" alt="User Image">
                    <span class="user-name">${post.userName}</span>
                </div>
                <div class="post-timestamp">${formatTimestamp(post.timestamp)}</div>
                <div class="post-content">${post.text}</div>
                <div class="interaction-buttons">
                    <button id="likeButton-${postId}" onclick="toggleLike('${postId}')" class="like-button"><i class="fas fa-thumbs-up"></i> (<span id="likeCount-${postId}">${Object.keys(post.likes || {}).length}</span>)</button>
                    <button onclick="sharePost('${postId}')"><i class="fas fa-share"></i></button>
                    <button onclick="toggleComments('${postId}')"><i class="fas fa-comments"></i></button>
                    ${isCurrentUserPost ? `<button onclick="deletePost('${postId}')"><i class="fas fa-trash"></i></button>` : ''}
                </div>
                <div id="comments-${postId}" style="display: none;">
                    <input type="text" id="commentInput-${postId}" class="form-control" placeholder="Write a comment...">
                    <button onclick="postComment('${postId}')" class="btn btn-primary">Post Comment</button>
                    <div id="comments-list-${postId}"></div>
                </div>
            `;

            // Set post content
            postElement.innerHTML = postContent;

            // Append post to posts section
            postsSection.insertBefore(postElement, postsSection.firstChild);

            // Fetch comments for the post
            fetchComments(postId);
        });
    });
}


 // Function to delete post
function deletePost(postId) {
    const user = firebase.auth().currentUser;
    if (user) {
        const confirmDelete = confirm("Are you sure you want to delete this post?");
        if (confirmDelete) {
            firebase.database().ref(`posts/${postId}`).remove()
                .then(() => {
                    console.log('Post deleted successfully');
                    // Optionally, you can reload the posts after deletion
                    fetchPosts();
                })
                .catch((error) => {
                    console.error('Error deleting post:', error);
                });
        }
    } else {
        console.log('User not logged in');
    }
}

        // Function to generate HTML for a single post
        function generatePostHTML(post) {
            const user = firebase.auth().currentUser;
            const isCurrentUserPost = user && post.userId === user.uid;
            const deleteIcon = isCurrentUserPost ? `<i class="fas fa-trash" onclick="deletePost('${post.postId}')"></i>` : '';
            return `
                <div class="post">
                    <!-- Post content -->
                    <!-- Post content -->
                    <!-- Post content -->
                    <!-- Post content -->
                    ${deleteIcon}
                </div>
            `;
        }
        
 // Function to fetch comments for a post
function fetchComments(postId) {
    firebase.database().ref(`posts/${postId}/comments`).on('value', (snapshot) => {
        const commentsList = document.getElementById(`comments-list-${postId}`);
        commentsList.innerHTML = ''; // Clear previous comments
        snapshot.forEach((childSnapshot) => {
            const comment = childSnapshot.val();
            const commentId = childSnapshot.key;
            const commentElement = document.createElement('div');
            commentElement.classList.add('comment');

            // Check if the current user is the owner of the comment
            const user = firebase.auth().currentUser;
            const isCurrentUserComment = user && comment.userId === user.uid;

            // Construct comment content
            const commentContent = `
                <div class="comment-content">
                    <span class="user-name">${comment.userName}</span>: ${comment.commentText}
                </div>
                <div class="comment-buttons">
                    <button onclick="likeComment('${postId}', '${commentId}')"><i class="fas fa-thumbs-up"></i> (<span id="commentLikeCount-${postId}-${commentId}">${Object.keys(comment.likes || {}).length}</span>)</button>
                    ${isCurrentUserComment ? `<button onclick="deleteComment('${postId}', '${commentId}')"><i class="fas fa-trash"></i></button>` : ''}
                    <!-- Render delete button only if the current user is the owner of the comment -->
                </div>
            `;

            // Set comment content
            commentElement.innerHTML = commentContent;

            // Append comment to comments list
            commentsList.appendChild(commentElement);
        });
    });
}


    // Function to post comment
    function postComment(postId) {
        const user = firebase.auth().currentUser;
        const commentInput = document.getElementById(`commentInput-${postId}`);
        const commentText = commentInput.value.trim();
        if (commentText !== '' && user) {
            firebase.database().ref(`posts/${postId}/comments`).push({
                userId: user.uid,
                userName: user.displayName,
                commentText: commentText,
                likes: {} // Initialize likes as object to store user likes
            }).then(() => {
                commentInput.value = '';
            }).catch((error) => {
                console.error('Error posting comment:', error);
            });
        }
    }

    // Function to toggle like on post
    function toggleLike(postId) {
        const user = firebase.auth().currentUser;
        if (user) {
            const likeButton = document.getElementById(`likeButton-${postId}`);
            const likeCount = document.getElementById(`likeCount-${postId}`);
            const postRef = firebase.database().ref(`posts/${postId}/likes/${user.uid}`);
            postRef.transaction((like) => {
                if (like) {
                    likeButton.classList.remove('liked-button');
                    return null; // Remove like
                } else {
                    likeButton.classList.add('liked-button');
                    return true; // Add like
                }
            }).then(() => {
                postRef.once('value', (snapshot) => {
                    likeCount.textContent = snapshot.numChildren();
                });
            });
        } else {
            console.log('User not logged in');
        }
    }

    // Function to like a comment
    function likeComment(postId, commentId) {
        const user = firebase.auth().currentUser;
        if (user) {
            const commentLikeCount = document.getElementById(`commentLikeCount-${postId}-${commentId}`);
            const commentRef = firebase.database().ref(`posts/${postId}/comments/${commentId}/likes/${user.uid}`);
            commentRef.transaction((like) => {
                if (like) {
                    return null; // Remove like
                } else {
                    return true; // Add like
                }
            }).then(() => {
                commentRef.once('value', (snapshot) => {
                    commentLikeCount.textContent = snapshot.numChildren();
                });
            });
        } else {
            console.log('User not logged in');
        }
    }

    // Function to delete comment
    function deleteComment(postId, commentId) {
        const user = firebase.auth().currentUser;
        if (user) {
            const confirmDelete = confirm("Are you sure you want to delete this comment?");
            if (confirmDelete) {
                firebase.database().ref(`posts/${postId}/comments/${commentId}`).remove()
                .catch((error) => {
                    console.error('Error deleting comment:', error);
                });
            }
        } else {
            console.log('User not logged in');
        }
    }

    // Function to toggle comments section
    function toggleComments(postId) {
        const commentsSection = document.getElementById(`comments-${postId}`);
        if (commentsSection.style.display === 'none') {
            commentsSection.style.display = 'block';
        } else {
            commentsSection.style.display = 'none';
        }
    }

    // Function to share a post
    function sharePost(postId) {
        const postUrl = window.location.href + `?postId=${postId}`;
        navigator.clipboard.writeText(postUrl)
        .then(() => {
            alert('Post link copied to clipboard');
        })
        .catch((error) => {
            console.error('Error copying to clipboard:', error);
        });
    }

    // Function to format timestamp
    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString();
    }

    // Fetch user details and posts on page load
    window.onload = function() {
        fetchUserDetails();
        fetchPosts();
    };
</script>

</body>
</html>
